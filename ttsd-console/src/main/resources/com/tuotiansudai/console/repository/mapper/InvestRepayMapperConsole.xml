<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tuotiansudai.console.repository.mapper.InvestRepayMapperConsole">

    <cache-ref namespace="com.tuotiansudai.repository.mapper.InvestRepayMapper"/>

    <resultMap id="investRepayExperienceResultMap" type="InvestRepayExperienceView">
        <result column="mobile" property="mobile"/>
        <result column="experience_balance" property="experienceBalance"/>
        <result column="repay_date" property="repayDate"/>
        <result column="actual_repay_date" property="actualRepayDate"/>
        <result column="expected_interest" property="expectedInterest"/>
        <result column="actual_interest" property="actualInterest"/>
        <result column="status" property="repayStatus"/>
    </resultMap>

    <select id="findInvestRepayExperience" parameterType="map" resultMap="investRepayExperienceResultMap">
        SELECT
        u.mobile,u.experience_balance,ir.repay_date,ir.actual_repay_date,ir.expected_interest,ir.actual_interest,ir.status
        FROM
        invest_repay ir
        JOIN
        invest i ON ir.invest_id = i.id AND i.loan_id = 1
        JOIN
        user u ON i.login_name = u.login_name
        <where>
            <if test="mobile != null and mobile !=''">
                and u.mobile = #{mobile}
            </if>
            <if test="repayDateMin != null">
                and ir.repay_date >= #{repayDateMin}
            </if>
            <if test="repayDateMax != null">
                and ir.repay_date &lt;= #{repayDateMin}
            </if>
            <if test="repayStatus != null">
                and ir.status = #{repayStatus}
            </if>
        </where>
        ORDER BY ir.repay_date
        limit #{index},#{pageSize}
    </select>

    <select id="findCountInvestRepayExperience" parameterType="map" resultType="int">
        SELECT
        count(*)
        FROM
        invest_repay ir
        JOIN
        invest i ON ir.invest_id = i.id AND i.loan_id = 1
        JOIN
        user u ON i.login_name = u.login_name
        <where>
            <if test="mobile != null and mobile !=''">
                and u.mobile = #{mobile}
            </if>
            <if test="repayDateMin != null">
                and ir.repay_date >= #{repayDateMin}
            </if>
            <if test="repayDateMax != null">
                and ir.repay_date &lt;= #{repayDateMin}
            </if>
            <if test="repayStatus != null">
                and ir.status = #{repayStatus}
            </if>
        </where>
    </select>

    <select id="findSumExpectedInterestExperience" parameterType="map" resultType="long">
        SELECT
        sum(ir.expected_interest)
        FROM
        invest_repay ir
        JOIN
        invest i ON ir.invest_id = i.id AND i.loan_id = 1
        JOIN
        user u ON i.login_name = u.login_name
        <where>
            <if test="mobile != null and mobile !=''">
                and u.mobile = #{mobile}
            </if>
            <if test="repayDateMin != null">
                and ir.repay_date >= #{repayDateMin}
            </if>
            <if test="repayDateMax != null">
                and ir.repay_date &lt;= #{repayDateMin}
            </if>
            <if test="repayStatus != null">
                and ir.status = #{repayStatus}
            </if>
        </where>
    </select>

    <select id="findSumActualInterestExperience" parameterType="map" resultType="long">
        SELECT
        sum(ir.repay_amount)
        FROM
        invest_repay ir
        JOIN
        invest i ON ir.invest_id = i.id AND i.loan_id = 1
        JOIN
        user u ON i.login_name = u.login_name
        <where>
            <if test="mobile != null and mobile !=''">
                and u.mobile = #{mobile}
            </if>
            <if test="repayDateMin != null">
                and ir.repay_date >= #{repayDateMin}
            </if>
            <if test="repayDateMax != null">
                and ir.repay_date &lt;= #{repayDateMin}
            </if>
            <if test="repayStatus != null">
                and ir.status = #{repayStatus}
            </if>
        </where>
    </select>
</mapper>