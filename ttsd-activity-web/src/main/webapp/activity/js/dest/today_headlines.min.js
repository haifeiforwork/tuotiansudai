require(["jquery","layerWrapper","template","commonFun","jquery.validate","jquery.validate.extension","jquery.ajax.extension","jquery.form"],function(a,b,c){a(function(){function c(){a(".captcha-register").attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())}function d(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#registerBox")}),c()}function e(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#loginBox")}),g()}function f(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#lastBox")})}function g(){a(".captcha-login").attr("src","/login/captcha?"+(new Date).getTime().toString())}var h=a("#registerForm"),i=a("#loginForm"),j=a("#attestForm"),k=!1,l=!1,m=!1,n=a("#appCaptcha",h),o=a(".fetch-captcha",h);a(".download-btn").on("click",function(b){b.preventDefault(),location.href=a(this).attr("data-href")}),c(),a(".captcha-register").on("click",c),n.on("keyup",function(b){/^\d{5}$/.test(b.target.value)&&(a(b.target).addClass("valid").removeClass("error"),m=!0,k=a("#mobile").hasClass("valid"),l=a("#password").hasClass("valid"),k&&l&&m?(o.prop("disabled",!1),a("#appCaptcha-error").html("").hide()):o.prop("disabled",!0))}),o.on("click",function(d){var e=a(this);if(d.preventDefault(),!e.prop("disabled")){o.prop("disabled",!0);var f=n.val(),g=a("#mobile").val();a.ajax({url:"/register/user/send-register-captcha",type:"POST",dataType:"json",data:{imageCaptcha:f,mobile:g}}).done(function(a){var d,e=a.data,f=60;return e.status&&!e.isRestricted?void(d=setInterval(function(){o.prop("disabled",!0).text(f+"秒后重发"),f--,0==f&&(clearInterval(d),o.prop("disabled",!1).text("重新发送"))},1e3)):(!e.status&&e.isRestricted&&b.msg("短信发送频繁,请稍后再试"),void(e.status||e.isRestricted||(b.msg("图形验证码错误"),c())))}).fail(function(){b.msg("请求失败，请重试！"),o.prop("disabled",!1),c()})}}),a(".show-agreement").on("click",function(c){c.preventDefault(),b.open({type:1,title:"拓天速贷服务协议",area:["100%","100%"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#agreementBox")})}),jQuery.validator.addMethod("isPhone",function(a,b){var c=/0?(13|14|15|18)[0-9]{9}/;return this.optional(b)||c.test(a)},"请正确填写您的手机号码"),jQuery.validator.addMethod("checkCaptcha",function(b,c){var d=$phoneDom.val(),e=a.Deferred();return/^\d{6}$/.test(b)&&d?a.ajax({url:"/register/user/mobile/"+d+"/captcha/"+b+"/verify",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(e.resolve(),m=!0):(e.reject(),m=!1)}}):(e.reject(),m=!1),"resolved"==e.state()},"验证码不正确"),h.validate({debug:!0,rules:{mobile:{required:!0,digits:!0,isPhone:!0,minlength:11,maxlength:11,isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,regex:/^(?=.*[^\d])(.{6,20})$/},appCaptcha:{required:!0},captcha:{required:!0,digits:!0,maxlength:6,minlength:6,checkCaptcha:!0}},messages:{mobile:{required:"请输入手机号",digits:"必须是数字",minlength:"手机格式不正确",isPhone:"请输入正确的手机号码",maxlength:"手机格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"6位至20位，不能全是数字"},appCaptcha:{required:"请输入验证码"},captcha:{required:"请输入手机验证码",digits:"验证码格式不正确",maxlength:"验证码格式不正确",minlength:"验证码格式不正确",checkCaptcha:"验证码不正确"}},submitHandler:function(c){a.ajax({url:"/register/user",data:a(c).serialize(),type:"POST",dataType:"json",beforeSend:function(){h.find(".register-user").prop("disabled",!0)}}).done(function(a){console.log(a)}).fail(function(){b.msg("请求失败，请重试！")})}}),a(".login-btn",a("#registerBox")).on("click",e),a(".go-register",a("#loginBox")).on("click",d),g(),a(".captcha-login").on("click",g),i.validate({rules:{username:{required:!0},password:{required:!0},captcha:{required:!0,minlength:5}},messages:{username:{required:"用户名不能为空"},password:{required:"密码不能为空"},captcha:{required:"验证码不能为空",minlength:"验证码不正确"}},submitHandler:function(c){a.ajax({url:"/login",data:a(c).serialize(),type:"POST",dataType:"json",beforeSend:function(){i.find(".register-user").prop("disabled",!0)}}).done(function(a){console.log(a)}).fail(function(){b.msg("请求失败，请重试！")})}}),j.validate({focusCleanup:!0,focusInvalid:!1,onfocusout:function(b){this.element(b),2==a("input.valid",registerAccountForm).length&&j.find(".register-user").prop("disabled",!1)},submitHandler:function(c){return a(c).ajaxSubmit({dataType:"json",beforeSubmit:function(a,b,c){j.find(".register-user").val("认证中...").prop("disabled",!0)},success:function(a){a.data.status?(j.find(".register-user").val("立即认证"),b.closeAll(),b.msg("认证成功"),setInterval(f,3e3)):(b.msg("认证失败，请检查后重试！"),j.find(".register-user").val("立即认证").prop("disabled",!1))},error:function(a){b.msg("认证失败，请检查后重试！"),j.find(".register-user").val("立即认证").prop("disabled",!1)}}),!1},onkeyup:function(b,c){var d=[16,17,18,20,35,36,37,38,39,40,45,144,225];9===c.which&&""===this.elementValue(b)||a.inArray(c.keyCode,d)!==-1||this.element(b)},rules:{username:{required:!0},identityNumber:{required:!0,identityCheckValid:!0,identityCardAge:!0,isExist:"/register/account/identity-number/{0}/is-exist"}},messages:{username:{required:"请输入姓名"},identityNumber:{required:"请输入身份证号",identityCheckValid:"您的身份证号码不正确",identityCardAge:"年龄未满18周岁",isExist:"身份证已存在"}}})})});