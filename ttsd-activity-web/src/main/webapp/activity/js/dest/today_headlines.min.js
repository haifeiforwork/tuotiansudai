require(["jquery","layerWrapper","template","commonFun","jquery.validate","jquery.validate.extension","jquery.form","jquery.ajax.extension"],function(a,b,c,d){a(function(){function c(){a.ajax({url:"/activity/headlines-today/draw",type:"POST",dataType:"json",data:{mobile:a("#loginMobile").val()}}).done(function(c){if(1==c.returnCode)h();else if(0==c.returnCode){switch(c.prize){case"T1_PHONE":s.num=7;break;case"INSPISSATE_TOWEL":s.num=0;break;case"FLYCO_HAIR_DRIER":s.num=1;break;case"IQIYI_MEMBERSHIP_MONTH_REF_CARNIVAL":s.num=5;break;case"TELEPHONE_FARE_10_YUAN_REF_CARNIVAL":s.num=2;break;case"BAMBOO_BAG":s.num=6;break;case"QQ_EMOTICON_PILLOW":s.num=3;break;case"RED_ENVELOPE_50_YUAN_DRAW_REF_CARNIVAL":s.num=4}s.show(s.num),"REGISTER_LOGIN_TO_ACCOUNT"==r.val()?a("#attestBox").find(".gift-name").text("注册成功，获得了"+c.prizeValue):"LOGIN_TO_ACCOUNT"==r.val()&&a("#lastBox").find(".gift-name").text("恭喜您解救了"+c.prizeValue)}else 3==c.returnCode&&b.msg("当前活动已结束！")}).fail(function(){b.msg("抽奖失败，请重试")})}function d(){a(".captcha-register").attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())}function e(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#registerBox")}),d()}function f(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#loginBox")}),i()}function g(){b.closeAll(),c(),b.open({type:1,title:!1,closeBtn:2,content:a("#attestBox")})}function h(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#noChanceBox")})}function i(){a(".captcha-login").attr("src","/login/captcha?"+(new Date).getTime().toString())}var j=a("#registerForm"),k=a("#loginForm"),l=a("#attestForm"),m=!1,n=!1,o=!1,p=a("#appCaptcha",j),q=a(".fetch-captcha",j),r=a("#statusText"),s={click:!1,index:-1,count:0,timer:0,speed:20,times:0,cycle:50,prize:-1,num:0,init:function(b){a("#"+b).find(".lottery-unit").length>0&&($lottery=a("#"+b),$units=$lottery.find(".lottery-unit"),this.obj=$lottery,this.count=$units.length,$lottery.find(".lottery-unit-"+this.index).addClass("active"))},roll:function(){var b=this.index,c=this.count,d=this.obj;return a(d).find(".lottery-unit-"+b).removeClass("active"),b+=1,b>c-1&&(b=0),a(d).find(".lottery-unit-"+b).addClass("active"),this.index=b,!1},show:function(b){a("#lottery").find(".lottery-unit-"+b).addClass("active").removeClass("hiding").siblings().removeClass("active")},eventRoll:function(){if(s.times+=1,s.roll(),s.times>s.cycle+10&&s.prize==s.index)clearTimeout(s.timer),s.prize=-1,s.times=0,s.click=!1;else{if(s.times<s.cycle)s.speed-=10;else if(s.times==s.cycle){var a=Math.random()*s.count|0;s.prize=a}else s.times>s.cycle+10&&(0==s.prize&&7==s.index||s.prize==s.index+1)?s.speed+=110:s.speed+=20;s.speed<40&&(s.speed=40),s.timer=setTimeout(s.eventRoll,s.speed)}return!1}};switch(s.init("lottery"),a("#lottery .lottery-btn").on("click",function(b){return b.preventDefault(),!s.click&&(a("#lottery .lottery-unit").addClass("hiding"),s.speed=100,s.eventRoll(),s.click=!0,void 0)}),r.val()){case"REGISTER_LOGIN_TO_ACCOUNT":g(),a("#attestBox").find(".gift-title").show();break;case"LOGIN_TO_ACCOUNT":g(),a("#attestBox").find(".gift-title").hide()}a(".download-btn").on("click",function(b){b.preventDefault(),location.href=a(this).attr("data-href")}),d(),a(".captcha-register").on("click",d),p.on("keyup",function(b){/^\d{5}$/.test(b.target.value)&&(a(b.target).addClass("valid").removeClass("error"),o=!0,m=a("#mobile").hasClass("valid"),n=a("#password").hasClass("valid"),m&&n&&o?(q.prop("disabled",!1),a("#appCaptcha-error").html("").hide()):q.prop("disabled",!0))}),q.on("click",function(c){c.preventDefault();var e=a(this);if(!e.prop("disabled")){q.prop("disabled",!0);var f=p.val(),g=a("#mobile").val();a.ajax({url:"/register/user/send-register-captcha",type:"POST",dataType:"json",data:{imageCaptcha:f,mobile:g}}).done(function(a){var c,e=a.data,f=60;return e.status&&!e.isRestricted?void(c=setInterval(function(){q.prop("disabled",!0).text(f+"秒后重发"),f--,0==f&&(clearInterval(c),q.prop("disabled",!1).text("重新发送"))},1e3)):!e.status&&e.isRestricted?(b.msg("短信发送频繁,请稍后再试"),!1):e.status||e.isRestricted?void 0:(b.msg("图形验证码错误"),d(),!1)}).fail(function(){return b.msg("请求失败，请重试！"),q.prop("disabled",!1),d(),!1})}}),a(".show-agreement").on("click",function(c){c.preventDefault(),b.open({type:1,title:"拓天速贷服务协议",area:["100%","100%"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#agreementBox")})}),jQuery.validator.addMethod("isPhone",function(a,b){var c=/0?(13|14|15|18)[0-9]{9}/;return this.optional(b)||c.test(a)},"请正确填写您的手机号码"),jQuery.validator.addMethod("checkCaptcha",function(b,c){var d=a("#mobile").val(),e=a.Deferred();return/^\d{6}$/.test(b)&&d?a.ajax({url:"/register/user/mobile/"+d+"/captcha/"+b+"/verify",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(e.resolve(),o=!0):(e.reject(),o=!1)}}):(e.reject(),o=!1),"resolved"==e.state()},"验证码不正确"),j.validate({debug:!0,rules:{mobile:{required:!0,digits:!0,isPhone:!0,minlength:11,maxlength:11,isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,regex:/^(?=.*[^\d])(.{6,20})$/},appCaptcha:{required:!0},captcha:{required:!0,digits:!0,maxlength:6,minlength:6,checkCaptcha:!0}},messages:{mobile:{required:"请输入手机号",digits:"必须是数字",minlength:"手机格式不正确",isPhone:"请输入正确的手机号码",maxlength:"手机格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"6位至20位，不能全是数字"},appCaptcha:{required:"请输入验证码"},captcha:{required:"请输入手机验证码",digits:"验证码格式不正确",maxlength:"验证码格式不正确",minlength:"验证码格式不正确",checkCaptcha:"验证码不正确"}},submitHandler:function(a){a.submit()}}),a(".login-btn",a("#registerBox")).on("click",f),a(".go-register",a("#loginBox")).on("click",e),i(),a(".captcha-login").on("click",i),k.validate({rules:{username:{required:!0},password:{required:!0},captcha:{required:!0,minlength:5}},messages:{username:{required:"用户名不能为空"},password:{required:"密码不能为空"},captcha:{required:"验证码不能为空",minlength:"验证码不正确"}},submitHandler:function(c){k.ajaxSubmit({beforeSubmit:function(a,b,c){k.find(".register-user").prop("disabled",!0)},success:function(c){return c.status?(a("#loginMobile").val(a("#username").val()),a("#attestBox").find(".gift-title").hide(),g("user"),!1):(i(),k.find(".register-user").prop("disabled",!1),b.msg(c.message),!1)},error:function(){return k.find(".register-user").prop("disabled",!1),i(),b.msg("用户或密码不正确"),!1}})}}),l.validate({focusCleanup:!0,focusInvalid:!1,onfocusout:function(b){this.element(b),2==a("input.valid",l).length&&l.find(".register-user").prop("disabled",!1)},submitHandler:function(c){return a(c).ajaxSubmit({dataType:"json",beforeSubmit:function(a,b,c){l.find(".register-user").val("认证中...").prop("disabled",!0)},success:function(a){a.data.status?(l.find(".register-user").val("立即认证"),b.closeAll(),b.msg("认证成功",function(){location.reload()})):(b.msg("认证失败，请检查后重试！"),l.find(".register-user").val("立即认证").prop("disabled",!1))},error:function(a){b.msg("认证失败，请检查后重试！"),l.find(".register-user").val("立即认证").prop("disabled",!1)}}),!1},onkeyup:function(b,c){var d=[16,17,18,20,35,36,37,38,39,40,45,144,225];9===c.which&&""===this.elementValue(b)||a.inArray(c.keyCode,d)!==-1||this.element(b)},rules:{userName:{required:!0},identityNumber:{required:!0,identityCheckValid:!0,identityCardAge:!0,isExist:"/register/account/identity-number/{0}/is-exist"}},messages:{userName:{required:"请输入姓名"},identityNumber:{required:"请输入身份证号",identityCheckValid:"您的身份证号码不正确",identityCardAge:"年龄未满18周岁",isExist:"身份证已存在"}}})})});