require(["jquery","layerWrapper","template","commonFun","jquery.validate","jquery.validate.extension","jquery.ajax.extension","jquery.form"],function(a,b,c){a(function(){function c(){""!=a("#loginMobile").val()?i():f()}function d(c){a.ajax({url:"/activity/headlines-today/draw",type:"POST",dataType:"json",data:{mobile:a("#loginMobile").val()}}).done(function(d){if(1==d.returnCode)j();else if(0==d.returnCode){switch(d.prize){case"T1_PHONE":t.num=7;break;case"INSPISSATE_TOWEL":t.num=0;break;case"FLYCO_HAIR_DRIER":t.num=1;break;case"IQIYI_MEMBERSHIP_MONTH_REF_CARNIVAL":t.num=5;break;case"TELEPHONE_FARE_10_YUAN_REF_CARNIVAL":t.num=2;break;case"BAMBOO_BAG":t.num=6;break;case"QQ_EMOTICON_PILLOW":t.num=3;break;case"RED_ENVELOPE_50_YUAN_DRAW_REF_CARNIVAL":t.num=4}t.show(t.num),"register"==c?a("#attestBox").find(".gift-name").text("注册成功，获得了"+d.prizeValue):"user"==c&&a("#lastBox").find(".gift-name").text("恭喜您解救了"+d.prizeValue)}else 3==d.returnCode&&b.msg("当前活动已结束！")}).fail(function(){b.msg("抽奖失败，请重试")})}function e(){a(".captcha-register").attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())}function f(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#registerBox")}),e()}function g(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#loginBox")}),k()}function h(c){b.closeAll(),d(c),"user"==c?a("#attestBox").find(".gift-title").hide():a("#attestBox").find(".gift-title").show(),b.open({type:1,title:!1,closeBtn:2,content:a("#attestBox"),cancel:function(c){b.closeAll(),a("#loginMobile").val(""),a("#lastBox").find(".gift-title").hide()}})}function i(){b.closeAll(),d("user"),b.open({type:1,title:!1,closeBtn:2,content:a("#lastBox")})}function j(){b.closeAll(),b.open({type:1,title:!1,closeBtn:2,content:a("#noChanceBox")})}function k(){a(".captcha-login").attr("src","/login/captcha?"+(new Date).getTime().toString())}var l=a("#registerForm"),m=a("#loginForm"),n=a("#attestForm"),o=!1,p=!1,q=!1,r=a("#appCaptcha",l),s=a(".fetch-captcha",l),t={click:!1,index:-1,count:0,timer:0,speed:20,times:0,cycle:50,prize:-1,num:0,init:function(b){a("#"+b).find(".lottery-unit").length>0&&($lottery=a("#"+b),$units=$lottery.find(".lottery-unit"),this.obj=$lottery,this.count=$units.length,$lottery.find(".lottery-unit-"+this.index).addClass("active"))},roll:function(){var b=this.index,c=this.count,d=this.obj;return a(d).find(".lottery-unit-"+b).removeClass("active"),b+=1,b>c-1&&(b=0),a(d).find(".lottery-unit-"+b).addClass("active"),this.index=b,!1},show:function(b){a("#lottery").find(".lottery-unit-"+b).addClass("active").removeClass("hiding").siblings().removeClass("active")},eventRoll:function(){if(t.times+=1,t.roll(),t.times>t.cycle+10&&t.prize==t.index)clearTimeout(t.timer),t.prize=-1,t.times=0,t.click=!1,c();else{if(t.times<t.cycle)t.speed-=10;else if(t.times==t.cycle){var a=Math.random()*t.count|0;t.prize=a}else t.times>t.cycle+10&&(0==t.prize&&7==t.index||t.prize==t.index+1)?t.speed+=110:t.speed+=20;t.speed<40&&(t.speed=40),t.timer=setTimeout(t.eventRoll,t.speed)}return!1}};t.init("lottery"),a("#lottery .lottery-btn").on("click",function(b){return b.preventDefault(),!t.click&&(a("#lottery .lottery-unit").addClass("hiding"),t.speed=100,t.eventRoll(),t.click=!0,void 0)}),a(".download-btn").on("click",function(b){b.preventDefault(),location.href=a(this).attr("data-href")}),e(),a(".captcha-register").on("click",e),r.on("keyup",function(b){/^\d{5}$/.test(b.target.value)&&(a(b.target).addClass("valid").removeClass("error"),q=!0,o=a("#mobile").hasClass("valid"),p=a("#password").hasClass("valid"),o&&p&&q?(s.prop("disabled",!1),a("#appCaptcha-error").html("").hide()):s.prop("disabled",!0))}),s.on("click",function(c){c.preventDefault();var d=a(this);if(!d.prop("disabled")){s.prop("disabled",!0);var f=r.val(),g=a("#mobile").val();a.ajax({url:"/register/user/send-register-captcha",type:"POST",dataType:"json",data:{imageCaptcha:f,mobile:g}}).done(function(a){var c,d=a.data,f=60;return d.status&&!d.isRestricted?void(c=setInterval(function(){s.prop("disabled",!0).text(f+"秒后重发"),f--,0==f&&(clearInterval(c),s.prop("disabled",!1).text("重新发送"))},1e3)):!d.status&&d.isRestricted?(b.msg("短信发送频繁,请稍后再试"),!1):d.status||d.isRestricted?void 0:(b.msg("图形验证码错误"),e(),!1)}).fail(function(){return b.msg("请求失败，请重试！"),s.prop("disabled",!1),e(),!1})}}),a(".show-agreement").on("click",function(c){c.preventDefault(),b.open({type:1,title:"拓天速贷服务协议",area:["100%","100%"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#agreementBox")})}),jQuery.validator.addMethod("isPhone",function(a,b){var c=/0?(13|14|15|18)[0-9]{9}/;return this.optional(b)||c.test(a)},"请正确填写您的手机号码"),jQuery.validator.addMethod("checkCaptcha",function(b,c){var d=a("#mobile").val(),e=a.Deferred();return/^\d{6}$/.test(b)&&d?a.ajax({url:"/register/user/mobile/"+d+"/captcha/"+b+"/verify",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(e.resolve(),q=!0):(e.reject(),q=!1)}}):(e.reject(),q=!1),"resolved"==e.state()},"验证码不正确"),l.validate({debug:!0,rules:{mobile:{required:!0,digits:!0,isPhone:!0,minlength:11,maxlength:11,isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,regex:/^(?=.*[^\d])(.{6,20})$/},appCaptcha:{required:!0},captcha:{required:!0,digits:!0,maxlength:6,minlength:6,checkCaptcha:!0}},messages:{mobile:{required:"请输入手机号",digits:"必须是数字",minlength:"手机格式不正确",isPhone:"请输入正确的手机号码",maxlength:"手机格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"6位至20位，不能全是数字"},appCaptcha:{required:"请输入验证码"},captcha:{required:"请输入手机验证码",digits:"验证码格式不正确",maxlength:"验证码格式不正确",minlength:"验证码格式不正确",checkCaptcha:"验证码不正确"}},submitHandler:function(c){a.ajax({url:"/register/user/noRedirect",data:a(c).serialize(),type:"POST",dataType:"json",beforeSend:function(){l.find(".register-user").prop("disabled",!0)}}).done(function(b){return a("#loginMobile").val(a("#mobile").val()),h("register"),!1}).fail(function(){l.find(".register-user").prop("disabled",!1),b.msg("请求失败，请重试！")})}}),a(".login-btn",a("#registerBox")).on("click",g),a(".go-register",a("#loginBox")).on("click",f),k(),a(".captcha-login").on("click",k),m.validate({rules:{username:{required:!0},password:{required:!0},captcha:{required:!0,minlength:5}},messages:{username:{required:"用户名不能为空"},password:{required:"密码不能为空"},captcha:{required:"验证码不能为空",minlength:"验证码不正确"}},submitHandler:function(c){m.ajaxSubmit({beforeSubmit:function(a,b,c){m.find(".register-user").prop("disabled",!0)},success:function(c){return c.status?(a("#loginMobile").val(a("#username").val()),a("#attestBox").find(".gift-title").hide(),h("user"),!1):(k(),m.find(".register-user").prop("disabled",!1),b.msg(c.message),!1)},error:function(){return m.find(".register-user").prop("disabled",!1),k(),b.msg("用户或密码不正确"),!1}})}}),n.validate({focusCleanup:!0,focusInvalid:!1,onfocusout:function(b){this.element(b),2==a("input.valid",n).length&&n.find(".register-user").prop("disabled",!1)},submitHandler:function(c){return a(c).ajaxSubmit({dataType:"json",beforeSubmit:function(a,b,c){n.find(".register-user").val("认证中...").prop("disabled",!0)},success:function(a){a.data.status?(n.find(".register-user").val("立即认证"),b.closeAll(),b.msg("认证成功"),setInterval(i,3e3)):(b.msg("认证失败，请检查后重试！"),n.find(".register-user").val("立即认证").prop("disabled",!1))},error:function(a){b.msg("认证失败，请检查后重试！"),n.find(".register-user").val("立即认证").prop("disabled",!1)}}),!1},onkeyup:function(b,c){var d=[16,17,18,20,35,36,37,38,39,40,45,144,225];9===c.which&&""===this.elementValue(b)||a.inArray(c.keyCode,d)!==-1||this.element(b)},rules:{username:{required:!0},identityNumber:{required:!0,identityCheckValid:!0,identityCardAge:!0,isExist:"/register/account/identity-number/{0}/is-exist"}},messages:{username:{required:"请输入姓名"},identityNumber:{required:"请输入身份证号",identityCheckValid:"您的身份证号码不正确",identityCardAge:"年龄未满18周岁",isExist:"身份证已存在"}}})})});