require(["jquery","pagination","mustache","text!/tpl/loan-invest-list.mustache","layerWrapper","underscore","fancybox","jquery.ajax.extension","autoNumeric","coupon-alert","red-envelope-float","jquery.form","commonFun","logintip","assign_coupon"],function(a,b,c,d,e,f){function g(a){e.tips('<i class="fa fa-times-circle"></i>'+a,".text-input-amount",{tips:[1,"#ff7200"],time:0})}function h(){E||a.ajax({url:"/no-password-invest/mark-remind",type:"POST",dataType:"json"}).done(function(){E=!0}),e.open({type:1,closeBtn:0,skin:"layer-tip-loanDetail",title:"免密投资",shadeClose:!1,btn:G?["继续投资","开启免密投资"]:["继续投资","前往联动优势授权"],area:["500px","160px"],content:'<p class="pad-m-tb tc">推荐您开通免密投资功能，简化投资过程，理财快人一步！</p>',btn1:function(){cnzzPush.trackClick("标的详情页","马上投资弹框","继续投资B"),j(),e.closeAll()},btn2:function(){cnzzPush.trackClick("标的详情页","马上投资弹框",G?"开启免密投资":"前往联动优势授权"),G?a.ajax({url:"/no-password-invest/enabled",type:"POST",dataType:"json"}).done(function(){F=!0,e.closeAll(),e.msg("开启成功！",function(){j()})}).fail(function(){e.closeAll(),e.msg("开启失败，请重试！")}):(i(),z.submit())}})}function i(){e.closeAll(),e.open({type:1,skin:"layer-tip-loanDetail",shadeClose:!1,title:"登录到联动优势支付平台开通免密投资",area:["500px","290px"],content:D,end:function(){location.reload()}})}function j(){var b=a("#investForm");if("/invest"===b.attr("action")){if(!N)return location.href="/login?redirect="+encodeURIComponent(location.href),!1;var c=S();if(!U())return g(0===c?"投资金额不能为0元！":"投资金额不能大于可投金额！"),!1;var d=parseInt((100*H).toFixed(0));if(c<d){var f="投资金额小于标的最小投资金额！";return e.tips('<i class="fa fa-times-circle"></i>'+f,".text-input-amount",{tips:[1,"#ff7200"],time:0,maxWidth:220}),!1}var h=parseInt(b.find(".account-amount").data("user-balance"))||0;if(c>h)return location.href="/recharge",!1}return p.val(p.autoNumeric("get")),F?void e.open({type:1,closeBtn:0,skin:"layer-tip-loanDetail",title:"免密投资",shadeClose:!1,btn:["取消","确认"],area:["300px","160px"],content:'<p class="pad-m-tb tc">确认投资？</p>',btn1:function(){cnzzPush.trackClick("67标的详情页","马上投资确认框","取消"),e.closeAll()},btn2:function(){cnzzPush.trackClick("68标的详情页","马上投资确认框","确认"),b.ajaxSubmit({dataType:"json",url:"/no-password-invest",beforeSubmit:function(){console.log("invest start"),x.addClass("loading")},success:function(a){e.closeAll(),x.removeClass("loading");var b=a.data;b.status?location.href="/invest-success":"新手标投资已超上限"==b.message?K():g(b.message)}})}}):void b.submit()}function k(){e.open({shadeClose:!1,title:"安心签代签署授权",btn:0,type:1,area:["400px","auto"],content:a("#getSkipPhone")})}function l(){a("#getSkipCode").val(Y+"s").prop("disabled",!0),0==Y&&(clearInterval(X),a("#getSkipCode").val("重新获取验证码").prop("disabled",!1)),Y--}function m(){e.closeAll(),a("#skipSuccess").show(),setInterval(function(){a("#skipSuccess").hide(),E||F?j():h()},3e3)}var n=a(".loan-detail-content"),o=a(".hid-loan").val(),p=a(".text-input-amount",n),q=a(".account-info",n),r=a(".btn-pay",q),s=a(".loan-nav li"),t=a(".loan-list",n),u=a(".pagination",n),v=a(".errorTip"),w=a(".errorType"),x=a("#investSubmit"),y=a("#noPasswordTips"),z=a("#goAuthorize"),A=a(".fail_go_on_invest"),B=a(".success_go_on_invest"),C=a(".again-btn"),D=a("#authorizeAgreementOptions"),E=p.data("no-password-remind"),F=p.data("no-password-invest"),G=p.data("auto-invest-on"),H=a(".text-input-amount").data("min-invest-amount"),I=a("#isSkipAuth"),J=commonFun.browserRedirect();a(".extra-rate .fa-mobile").on("mouseover",function(b){b.preventDefault();var c=a(this);e.tips("APP投资该项目享受最高0.8%年化收益奖励",c,{tips:3})}),v.length>0&&""!=v.text()&&"OUT_OF_NOVICE_INVEST_LIMIT"!=w.val()&&g(v.text());var K=function(){e.open({shadeClose:!1,title:"新手体验特权",btn:["确认"],type:1,area:["500px","auto"],content:'<p class="pad-m-tb tc">抱歉，您已购买过新手专享产品，无法再次参加该活动。</p>',btn1:function(){e.closeAll()}})};"OUT_OF_NOVICE_INVEST_LIMIT"==w.val()&&K();var L=function(){u.loadPagination({index:1},function(b){if(b.status){b.achievementClass=function(){return function(a,b){var c={FIRST_INVEST:"first-icon",MAX_AMOUNT:"max-icon",LAST_INVEST:"last-icon"};return"<i class='"+c[b(a)]+"'></i>"}};var e=c.render(d,b);a(".loan-list-con table").html(e)}})};if(t.find(".loan-list-con").eq(0).show(),s.click(function(){var b=a(this);b.addClass("active").siblings("li").removeClass("active");var c=b.index();1===c&&L(),t.find(".loan-list-con").eq(c).show().siblings(".loan-list-con").hide()}),"PREHEAT"===n.data("loan-status")){var M=n.data("loan-countdown");window.setInterval(function(){var b=0,c=0,d=0,e=0;M<=1800&&(M>0?(d=Math.floor(M/60)-24*b*60-60*c,e=Math.floor(M)-24*b*60*60-60*c*60-60*d):(r.prop("disabled",!1),r.html("马上投资"),q.find(".time-item").remove(),q.find(".invest-amount").show(),q.find(".experience-ticket").show(),q.find(".expected-interest-dd").show()),d<=9&&(d="0"+d),e<=9&&(e="0"+e),a("#minute_show").html(d+"分"),a("#second_show").html(e+"秒"),M--)},1e3)}if(p.length){p.autoNumeric("init"),p.focus(function(){e.closeAll("tips")});var N="INVESTOR"===n.data("user-role"),O="USER"===n.data("authentication"),P=a(".ticket-list"),Q=a("#use-experience-ticket"),R=a(".experience-income"),S=function(){var a=0;return isNaN(p.autoNumeric("get"))||(a=parseInt((100*p.autoNumeric("get")).toFixed(0))),a},T=function(){var b=S();a.each(P.find("li"),function(c,d){var e=a(d),f=a(e.find("input")),g=e.data("product-type-usable"),h=a(e.find(".ticket-term.lower-limit")).data("invest-lower-limit")||0,i=!g||h>0&&h>b;f.prop("disabled",i),i?e.addClass("disabled"):e.removeClass("disabled")});var c=f.groupBy(P.find("li[data-coupon-type='RED_ENVELOPE'][data-product-type-usable='true']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),d=P.find("li[data-coupon-type='BIRTHDAY_COUPON'][data-product-type-usable='true']"),e=f.groupBy(P.find("li[data-coupon-type='NEWBIE_COUPON'][data-product-type-usable='true']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),g=f.groupBy(P.find("li[data-coupon-type='INVEST_COUPON'][data-product-type-usable='true']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),h=f.groupBy(P.find("li[data-coupon-type='INTEREST_COUPON'][data-product-type-usable='true']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),i=P.find("li[data-product-type-usable='false']");P.empty(),c.enabled&&P.append(f.sortBy(c.enabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),d.length>0&&P.append(d),e.enabled&&P.append(f.sortBy(e.enabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),g.enabled&&P.append(f.sortBy(g.enabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),h.enabled&&P.append(f.sortBy(h.enabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),c.disabled&&P.append(f.sortBy(c.disabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),e.disabled&&P.append(f.sortBy(e.disabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),g.disabled&&P.append(f.sortBy(g.disabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),h.disabled&&P.append(f.sortBy(h.disabled,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),i.length>0&&P.append(f.sortBy(i,function(b){var c=a(b);return new Date(c.data("coupon-end-time")).getTime()})),P.find("li").click(function(b){var c=a(b.currentTarget);if(c.hasClass("disabled"))return!1;var d=a.trim(c.find(".ticket-title").text());Q.find("span").text(d),c.find("input").prop("checked",!0),R.text(""),V(),P.addClass("hide")})},U=function(){var b=S(),c=parseInt(a("#investForm").find("input[name=amount]").data("amount-need-raised"))||0;return b>0&&c>=b},V=function(){var b=[];return a.each(a('input[type="hidden"][name="userCouponIds"]'),function(c,d){b.push({name:"couponIds",value:a(d).data("coupon-id")})}),P.find("li").each(function(c,d){a(d).find('input[type="radio"]:checked').length>0&&b.push({name:"couponIds",value:a(d).data("coupon-id")})}),0==b.length?void R.text(""):void a.ajax({url:"/calculate-expected-coupon-interest/loan/"+o+"/amount/"+S(),data:a.param(b),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(a){R.text("+"+a),r.prop("disabled",!1)})},W=function(){a.ajax({url:"/calculate-expected-interest/loan/"+o+"/amount/"+S(),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){a(".principal-income").text(b)})};N&&(W(),V()),p.blur(function(){W(),a.ajax({url:"/loan/"+o+"/amount/"+S()+"/max-benefit-user-coupon",type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){if(P.find('input[type="radio"]:checked').prop("checked",!1),console.log("calculate max coupon init"),isNaN(parseInt(b)))Q.hasClass("disabled")||Q.find("span").text("请选择优惠券");else{var c=a("#"+b),d=a.trim(P.find('li[data-user-coupon-id="'+b+'"]').find(".ticket-info .ticket-title").text());Q.find("span").text(d),c.prop("checked",!0),console.log("calculate max coupon finished")}V()})}),x.on("click",function(b){b.preventDefault(),a.ajax({url:"/isLogin",type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8"}).fail(function(b){if(""!=b.responseText){a("meta[name='_csrf']").remove(),a("head").append(a(b.responseText));var c=a("meta[name='_csrf']").attr("content"),d=a("meta[name='_csrf_header']").attr("content");a(document).ajaxSend(function(a,b,e){b.setRequestHeader(d,c)}),e.open({type:1,title:!1,closeBtn:0,area:["auto","auto"],content:a("#loginTip")}),a(".image-captcha img").trigger("click")}else{if(N)return"true"==I.val()?void(E||F?j():h()):("true"==a("#skipCheck").val()?k():a("#checkTip").show(),!1);O&&(location.href="/register/account")}})}),Q.click(function(b){var c=a(this);return!c.hasClass("disabled")&&(P.toggleClass("hide"),c.find(".fa-sort-down").toggleClass("hide").siblings(".fa-sort-up").toggleClass("hide"),P.hasClass("hide")||T(),void(b.stopPropagation?b.stopPropagation():window.event&&(window.event.cancelBubsuble=!0)))}),p.focus(function(a){P.addClass("hide")}),a("body").click(function(b){var c=b||window.event,d=c.srcElement||c.target;P.hasClass("hide")||0!=a(d).parents(".ticket-list").length||P.addClass("hide")})}y.on("click",function(){return e.open({type:1,closeBtn:0,skin:"layer-tip-loanDetail",shadeClose:!1,title:"免密投资",btn:["不开启","开启"],area:["500px","160px"],content:'<p class="pad-m-tb tc">您可直接开启免密投资，简化投资过程，理财快人一步，是否开启？</p>',btn1:function(){cnzzPush.trackClick("标的详情页","推荐免密弹框","不开启"),e.closeAll()},btn2:function(){cnzzPush.trackClick("标的详情页","推荐免密弹框","开启"),G?a.ajax({url:"/no-password-invest/enabled",type:"POST",dataType:"json"}).done(function(){F=!0,y.hide(),e.msg("开启成功！")}).fail(function(){e.msg("开启失败，请重试！")}).complete(function(){e.closeAll()}):(i(),z.submit())}}),!1}),D.on("click",".go-on-btn",function(a){a.preventDefault(),e.closeAll(),location.reload()}).on("click",".again-btn",function(a){a.preventDefault(),z.submit()}),C.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","重新授权")}),A.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","继续投资C1")}),B.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","继续投资C2")}),function(){var b=a("#extra-rate");if(!b.length)return!1;var c={getSize:function(a,b){return a[b]()},getOffset:function(a){return a.offset()},removeElement:function(a){a.length&&a.remove()},getRelativeRate:function(a,b){var c=f.findLastIndex(__extraRate,function(a){if(b>=a.minInvestAmount&&(a.maxInvestAmount>b||0===a.maxInvestAmount))return!0});return c!==-1?a[c].rate:""},replace:function(a){return a.replace(/,/g,"")}},d=f.compose(f.template,function(){return a("#extra-rate-popup-tpl").html()})(),e=f.partial(c.getOffset,b),g=f.partial(c.getSize,b),h=(g("width"),g("height")),i=f.compose(f.partial(function(a,b){return{left:a.left-5,top:a.top+b-10}},f,h),e),j=f.partial(function(b,c){return a(b).css(c).appendTo("body")},f,i()),k=f.compose(j,d),l=f.partial(f.compose(c.removeElement,a),"#extra-rate-popup");b.find(".fa").on({mouseover:f.partial(k,{__extraRate:__extraRate}),mouseout:function(){l()}});var m=f.partial(c.getRelativeRate,__extraRate),n=function(){var b=a("[data-extra-rate]");return function(a){b.html(a)}}(),o=function(a){return a?"+"+a:""};a("#investForm").find(".text-input-amount").on("change",f.compose(n,o,m,parseInt,c.replace,function(){return a(this).val()})).trigger("change")}(),a.fn.carousel=function(){return this.each(function(){var b,c=a(this),d=c.find(".left-button"),e=c.find(".right-button"),f=c.find(".scroll-content > .row"),g=f.find(".col"),h=g.length,i=0,j=a(window).width()>700?4:1,k=f.find("img").length;switch(J){case"pc":k<=4&&e.addClass("disabled"),b=200;break;case"mobile":k<=1&&e.addClass("disabled"),b=c.find(".scroll-content").width(),f.find("img").width(b),g.width(b)}e.on("click",function(){return!e.hasClass("disabled")&&(e.add(d).removeClass("disabled"),i++,i>=h-j&&e.addClass("disabled"),void f.stop().animate({marginLeft:(-b-10)*i}))}),d.on("click",function(){return!d.hasClass("disabled")&&(d.add(e).removeClass("disabled"),i--,0==i&&d.addClass("disabled"),void f.stop().animate({marginLeft:(-b-10)*i}))})})},a("[scroll-carousel]").carousel().find(".col").fancybox({titlePosition:"over",cyclic:!1,showCloseButton:!0,showNavArrows:!0,titleFormat:function(a,b,c,d){return""}}),function(){var b=function(a){return a?a:0},c=function(a){return d.data(a)},d=a("#investForm").find(".text-input-amount"),h=f.compose(parseFloat,b,c)("max-invest-amount"),i=f.compose(parseFloat,b,c)("min-invest-amount"),j=function(a){return a.replace(/,/g,"")},k=f.debounce(function(b){var c=a(this),d=f.compose(parseFloat,j)(c.val());e.closeAll("tips"),d>h?g("该项目每人限投"+h+"元"):d<i&&g("单笔最低投资"+i+"元")},300);d.on("keyup",k),q.find(".icon-graded").on("mouseover",function(){e.closeAll("tips");var b=f.compose(j)(d.val()),c=q.find(".expected-interest-dd"),g=[];a.each(a('input[type="hidden"][name="userCouponIds"]'),function(b,c){g.push({name:"couponIds",value:a(c).data("coupon-id")})}),P.find("li").each(function(b,c){a(c).find('input[type="radio"]:checked').length>0&&g.push({name:"couponIds",value:a(c).data("coupon-id")})});var h=0==g.length?0:g[0].value;a.ajax({url:"/get-membership-preference",type:"GET",dataType:"json",data:{loanId:o,investAmount:b,couponIds:h},contentType:"application/json; charset=UTF-8"}).done(function(a){var b=a.data;if(b.status){var d="V"+b.level+"会员，专享服务费"+b.rate+"折优惠，已多赚"+b.amount+"元";e.tips(d,c,{tips:[1,"#ff7200"],time:3e3,skin:"level-layer-tips",tipsMore:!0,area:"auto",maxWidth:"400"})}}).fail(function(){})})}(),a(".skip-group .skip-icon").on("click",function(b){b.preventDefault(),a(this).hasClass("active")?a(this).removeClass("active")&&a("#skipCheck").val("false")&&a("#checkTip").show()&&x.prop("disabled",!0):a(this).addClass("active")&&a("#skipCheck").val("true")&&a("#checkTip").hide()&&x.prop("disabled",!1)}),a(".tip-item .skip-icon").on("click",function(b){b.preventDefault(),a(this).hasClass("active")?a(this).removeClass("active")&&a("#tipCheck").val("false"):a(this).addClass("active")&&a("#tipCheck").val("true")});var X,Y=60;a("#getSkipCode").on("click",function(b){b.preventDefault();a(this);a.ajax({url:"/anxinSign/sendCaptcha",type:"POST",dataType:"json"}).done(function(a){l(),X=setInterval(l,1e3)}).fail(function(){e.msg("请求失败，请重试！")})}),a("#getSkipBtn").on("click",function(b){b.preventDefault();var c=a(this);""!=a("#skipPhoneCode").val()?a.ajax({url:"/anxinSign/verifyCaptcha",type:"POST",dataType:"json",data:{captcha:a("#skipPhoneCode").val(),skipAuth:a("#tipCheck").val()}}).done(function(b){c.removeClass("active").val("立即授权").prop("disabled",!1),b.success?m():a("#skipError").text("验证码不正确").show()}).fail(function(){c.removeClass("active").val("立即授权").prop("disabled",!1),e.msg("请求失败，请重试！")}).always(function(){c.addClass("active").val("授权中...").prop("disabled",!0)}):a("#skipError").text("验证码不能为空").show()}),a("#skipPhoneCode").on("keyup",function(b){b.preventDefault(),""!=a(this).val()?a("#skipError").text("").hide():a("#skipError").text("验证码不能为空").show()}),a("#serviceLayer").on("click",function(b){b.preventDefault(),e.open({type:1,title:"安心签服务协议",area:["950px","600px"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#serviceBox")})}),a("#privacyLayer").on("click",function(b){b.preventDefault(),e.open({type:1,title:"隐私条款",area:["950px","600px"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#privacyBox")})}),a("#numberLayer").on("click",function(b){b.preventDefault(),e.open({type:1,title:"CFCA数字证书服务协议",area:["950px","600px"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#numberBox")})})});