require(["jquery","pagination","mustache","text!/tpl/loan-invest-list.mustache","layerWrapper","underscore","fancybox","jquery.ajax.extension","autoNumeric","coupon-alert","red-envelope-float","jquery.form"],function(a,b,c,d,e,f){function g(a){e.tips('<i class="fa fa-times-circle"></i>'+a,".text-input-amount",{tips:[1,"#ff7200"],time:0})}function h(){flagInterval=i(L-M,!0),a("#countdown").html(flagInterval),M=parseInt(M)+1e3}function i(a,b){var c=864e5,d=36e5,e=6e4,f=Math.floor(a/c),g=Math.floor(a%c/d),h=Math.floor(a/d),i=Math.floor(a%c%d/e),j=Math.floor(a%c%d%e/1e3);return 10>i&&(i="0"+i),10>j&&(j="0"+j),b?h+":"+i+":"+j:f+"天"+g+"时"+i+"分"+j+"秒"}function j(){C||a.ajax({url:"/no-password-invest/mark-remind",type:"POST",dataType:"json"}).done(function(){C=!0}),e.open({type:1,closeBtn:0,skin:"demo-class",title:"免密投资",shadeClose:!1,btn:E?["继续投资","开启免密投资"]:["继续投资","前往联动优势授权"],area:["500px","160px"],content:'<p class="pad-m-tb tc">推荐您开通免密投资功能，简化投资过程，理财快人一步！</p>',btn1:function(){cnzzPush.trackClick("标的详情页","马上投资弹框","继续投资B"),l(),e.closeAll()},btn2:function(){cnzzPush.trackClick("标的详情页","马上投资弹框",E?"开启免密投资":"前往联动优势授权"),E?a.ajax({url:"/no-password-invest/enabled",type:"POST",dataType:"json"}).done(function(){D=!0,e.closeAll(),e.msg("开启成功！",function(){l()})}).fail(function(){e.closeAll(),e.msg("开启失败，请重试！")}):(k(),x.submit())}})}function k(){e.closeAll(),e.open({type:1,skin:"demo-class",shadeClose:!1,title:"登录到联动优势支付平台开通免密投资",area:["500px","290px"],content:B,end:function(){location.reload()}})}function l(){var b=a("#investForm");if("/invest"===b.attr("action")){if(!N)return location.href="/login?redirect="+encodeURIComponent(location.href),!1;var c=R();if(!T())return g(0===c?"投资金额不能为0元！":"投资金额不能大于可投金额！"),!1;var d=parseInt((100*F).toFixed(0));if(d>c){var f="投资金额小于标的最小投资金额！";return e.tips('<i class="fa fa-times-circle"></i>'+f,".text-input-amount",{tips:[1,"#ff7200"],time:0,maxWidth:220}),!1}var h=parseInt(b.find(".account-amount").data("user-balance"))||0;if(c>h)return location.href="/recharge",!1}return o.val(o.autoNumeric("get")),D?void e.open({type:1,closeBtn:0,skin:"demo-class",title:"免密投资",shadeClose:!1,btn:["取消","确认"],area:["300px","160px"],content:'<p class="pad-m-tb tc">确认投资？</p>',btn1:function(){cnzzPush.trackClick("67标的详情页","马上投资确认框","取消"),e.closeAll()},btn2:function(){cnzzPush.trackClick("68标的详情页","马上投资确认框","确认"),b.ajaxSubmit({dataType:"json",url:"/no-password-invest",beforeSubmit:function(){v.addClass("loading")},success:function(a){e.closeAll(),v.removeClass("loading");var b=a.data;b.status?location.href="/invest-success":g(b.message)}})}}):void b.submit()}var m=a(".loan-detail-content"),n=a(".hid-loan").val(),o=a(".text-input-amount",m),p=a(".account-info",m),q=a(".btn-pay",p),r=a(".loan-nav li"),s=a(".loan-list",m),t=a(".pagination",m),u=a(".errorTip"),v=a("#investSubmit"),w=a("#noPasswordTips"),x=a("#goAuthorize"),y=a(".fail_go_on_invest"),z=a(".success_go_on_invest"),A=a(".again-btn"),B=a("#authorizeAgreementOptions"),C=o.data("no-password-remind"),D=o.data("no-password-invest"),E=o.data("auto-invest-on"),F=a(".text-input-amount").data("min-invest-amount");a("#picListBox a").fancybox({titlePosition:"over",cyclic:!1,showCloseButton:!0,showNavArrows:!0,titleFormat:function(a,b,c,d){return'<span id="fancybox-title-over">'+(c+1)+" / "+b.length+(a.length?" &nbsp; "+a:"")+"</span>"}}),u.length&&g(u.text());var G=m.data("loan-progress");50>=G?(a(".chart-box .rount").css("webkitTransform","rotate("+3.6*G+"deg)"),a(".chart-box .rount2").hide()):(a(".chart-box .rount").css("webkitTransform","rotate(180deg)"),a(".chart-box .rount2").show(),a(".chart-box .rount2").css("webkitTransform","rotate("+3.6*(G-50)+"deg)"));var H=function(){t.loadPagination({index:1},function(b){if(b.status){var e=c.render(d,b);a(".loan-list-con table").html(e)}})};if(s.find(".loan-list-con").eq(0).show(),r.click(function(){var b=a(this);b.addClass("active").siblings("li").removeClass("active");var c=b.index();1===c&&H(),s.find(".loan-list-con").eq(c).show().siblings(".loan-list-con").hide()}),"PREHEAT"===m.data("loan-status")){var I=m.data("loan-countdown");window.setInterval(function(){var b=0,c=0,d=0,e=0;1800>=I&&(I>0?(d=Math.floor(I/60)-24*b*60-60*c,e=Math.floor(I)-24*b*60*60-60*c*60-60*d):(q.prop("disabled",!1),q.html("马上投资"),p.find(".time-item").remove(),p.find(".invest-amount").show(),p.find(".experience-ticket").show(),p.find(".expected-interest-dd").show()),9>=d&&(d="0"+d),9>=e&&(e="0"+e),a("#minute_show").html(d+"分"),a("#second_show").html(e+"秒"),I--)},1e3)}var J=a("#countdown").attr("data-time"),K=Date.parse(new Date(J)),L=K,M=(new Date).getTime();if(h(),setInterval(h,1e3),console.log(J),o.length){o.autoNumeric("init"),o.focus(function(){e.closeAll("tips")});var N="INVESTOR"===m.data("user-role"),O=a(".ticket-list"),P=a("#use-experience-ticket"),Q=a(".experience-income"),R=function(){var a=0;return isNaN(o.autoNumeric("get"))||(a=parseInt((100*o.autoNumeric("get")).toFixed(0))),a},S=function(){var b=R();a.each(O.find("li"),function(c,d){var e=a(d),f=a(e.find("input")),g=a(e.find(".ticket-term.lower-limit")).data("invest-lower-limit")||0,h=a(e.find(".ticket-term.upper-limit")).data("invest-upper-limit")||0,i=g>0&&g>b||h>0&&b>h;f.prop("disabled",i),i?e.addClass("disabled"):e.removeClass("disabled")});var c=f.groupBy(O.find("li[data-coupon-type='RED_ENVELOPE']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),d=f.groupBy(O.find("li[data-coupon-type!='RED_ENVELOPE'][data-coupon-type!='BIRTHDAY_COUPON']"),function(b){return a(b).hasClass("disabled")?"disabled":"enabled"}),e=O.find("li[data-coupon-type='BIRTHDAY_COUPON']");O.empty(),e.length>0&&O.append(e),c.enabled&&O.append(f.sortBy(c.enabled,function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()})),d.enabled&&O.append(f.sortBy(d.enabled,function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()})),c.disabled&&O.append(f.sortBy(c.disabled,function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()})),d.disabled&&O.append(f.sortBy(d.disabled,function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()})),O.find("li").click(function(b){var c=a(b.currentTarget);if(c.hasClass("disabled"))return!1;var d=a.trim(c.find(".ticket-title").text());P.find("span").text(d),c.find("input").prop("checked",!0),Q.text(""),U(),O.addClass("hide")})},T=function(){var b=R(),c=parseInt(a("form .amountNeedRaised-i").data("amount-need-raised"))||0;return b>0&&c>=b},U=function(){var b=[];return a.each(a('input[type="hidden"][name="userCouponIds"]'),function(c,d){b.push({name:"couponIds",value:a(d).data("coupon-id")})}),O.find("li").each(function(c,d){a(d).find('input[type="radio"]:checked').length>0&&b.push({name:"couponIds",value:a(d).data("coupon-id")})}),0==b.length?void Q.text(""):void a.ajax({url:"/calculate-expected-coupon-interest/loan/"+n+"/amount/"+R(),data:a.param(b),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(a){Q.text("+"+a),q.prop("disabled",!1)})},V=function(){a.ajax({url:"/calculate-expected-interest/loan/"+n+"/amount/"+R(),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){a(".principal-income").text(b)})};N&&(V(),U()),o.blur(function(){V(),U()}),o.keyup(function(b){if(N){var c=!0;O.find("li").each(function(b,d){"BIRTHDAY_COUPON"==a(d).attr("data-coupon-type")?(c=!1,a(d).find('input[type="radio"]').prop("checked",!0)):a(d).find('input[type="radio"]').prop("checked",!1)}),c?P.find("span").text("请选择优惠券"):P.find("span").text("生日福利")}}),v.on("click",function(a){return a.preventDefault(),N?void(C||D?l():j()):void(location.href="/login?redirect="+encodeURIComponent(location.href))}),P.click(function(b){var c=a(this);return c.hasClass("disabled")?!1:(O.toggleClass("hide"),c.find(".fa-sort-down").toggleClass("hide").siblings(".fa-sort-up").toggleClass("hide"),O.hasClass("hide")||S(),void(b.stopPropagation?b.stopPropagation():window.event&&(window.event.cancelBubsuble=!0)))}),o.focus(function(a){O.addClass("hide")}),a("body").click(function(b){var c=b||window.event,d=c.srcElement||c.target;O.hasClass("hide")||0!=a(d).parents(".ticket-list").length||O.addClass("hide")})}w.on("click",function(){return e.open({type:1,closeBtn:0,skin:"demo-class",shadeClose:!1,title:"免密投资",btn:["不开启","开启"],area:["500px","160px"],content:'<p class="pad-m-tb tc">您可直接开启免密投资，简化投资过程，理财快人一步，是否开启？</p>',btn1:function(){cnzzPush.trackClick("标的详情页","推荐免密弹框","不开启"),e.closeAll()},btn2:function(){cnzzPush.trackClick("标的详情页","推荐免密弹框","开启"),E?a.ajax({url:"/no-password-invest/enabled",type:"POST",dataType:"json"}).done(function(){D=!0,w.hide(),e.msg("开启成功！")}).fail(function(){e.msg("开启失败，请重试！")}).complete(function(){e.closeAll()}):(k(),x.submit())}}),!1}),B.on("click",".go-on-btn",function(a){a.preventDefault(),e.closeAll(),location.reload()}).on("click",".again-btn",function(a){a.preventDefault(),x.submit()}),A.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","重新授权")}),y.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","继续投资C1")}),z.on("click",function(){cnzzPush.trackClick("标的详情页","免密异步弹框","继续投资C2")})});