require(["jquery","pagination","mustache","text!/tpl/loan-invest-list.mustache","layerWrapper","csrf","autoNumeric"],function(a,b,c,d,e){var f=a(".loan-detail-content"),g=a(".hid-loan").val(),h=a(".text-input-amount",f),i=a(".account-info",f),j=a(".btn-pay",i),k=a(".loan-nav li"),l=a(".loan-list",f),m=a(".pagination",f),n=a(".errorTip");e.ready(function(){e.photos({photos:"#picListBox"})});var o=f.data("loan-progress");50>=o?(a(".chart-box .rount").css("webkitTransform","rotate("+3.6*o+"deg)"),a(".chart-box .rount2").hide()):(a(".chart-box .rount").css("webkitTransform","rotate(180deg)"),a(".chart-box .rount2").show(),a(".chart-box .rount2").css("webkitTransform","rotate("+3.6*(o-50)+"deg)"));var p=function(){m.loadPagination({index:1},function(b){if(b.status){var e=c.render(d,b);a(".loan-list-con table").html(e)}})};if(l.find(".loan-list-con").eq(0).show(),k.click(function(){var b=a(this);b.addClass("active").siblings("li").removeClass("active");var c=b.index();1===c&&p(),l.find(".loan-list-con").eq(c).show().siblings(".loan-list-con").hide()}),"PREHEAT"===f.data("loan-status")){var q=f.data("loan-countdown");window.setInterval(function(){var b=0,c=0,d=0,e=0;1800>=q&&(q>0?(d=Math.floor(q/60)-24*b*60-60*c,e=Math.floor(q)-24*b*60*60-60*c*60-60*d):(j.prop("disabled",!1),j.html("马上投资"),i.find(".time-item").remove(),i.find(".invest-amount").show(),i.find(".experience-ticket").show(),i.find(".expected-interest-dd").show()),9>=d&&(d="0"+d),9>=e&&(e="0"+e),a("#minute_show").html(d+"分"),a("#second_show").html(e+"秒"),q--)},1e3)}if(h.length){h.autoNumeric("init"),h.focus(function(){e.closeAll("tips")});var r="INVESTOR"===f.data("user-role"),s=a(".ticket-list"),t=a("#use-experience-ticket"),u=a(".experience-income"),v=function(){var a=0;return isNaN(h.autoNumeric("get"))||(a=parseInt((100*h.autoNumeric("get")).toFixed(0))),a},w=function(){s.find("li").each(function(b){var c=a(this),d=c.find("input[name='userCouponId']");c.removeClass("disabled"),d.prop("disabled",!1);var e=a(c.find(".ticket-term")),f=e.data("invest-lower-limit")||0;f>v()&&(c.addClass("disabled"),d.prop("disabled",!0))})},x=function(){var b=v(),c=parseInt(a("form .amountNeedRaised-i").data("amount-need-raised"))||0;return b>0&&c>=b},y=function(){a.ajax({url:"/calculate-expected-interest/loan/"+g+"/amount/"+v(),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){a(".principal-income").text((b/100).toFixed(2))})};r&&y(),h.blur(function(){y()}),h.keyup(function(b){u.text(""),r&&!a("#noCouponSelected").prop("checked")&&(s.find("input").prop("checked",!1),t.find("span").text("请点击选择优惠券"))}),a("form").submit(function(){var b=a(this);if("/invest"===b.attr("action")){if(!r)return location.href="/login?redirect="+encodeURIComponent(location.href),!1;if(!x()){var c=isNaN(h.autoNumeric("get"))||0===parseInt((100*h.autoNumeric("get")).toFixed(0))?"投资金额不能为0元！":"投资金额不能大于可投金额！";return e.tips('<i class="fa fa-times-circle"></i>'+c,".text-input-amount",{tips:[1,"#ff7200"],time:0}),!1}var d=v(),f=parseInt(a("form .account-amount").data("user-balance"))||0;if(d>f)return location.href="/recharge",!1}return!0}),t.click(function(b){var c=a(this);return c.hasClass("disabled")?!1:(s.toggleClass("hide"),c.find(".fa-sort-down").toggleClass("hide").siblings(".fa-sort-up").toggleClass("hide"),s.hasClass("hide")||w(),void(b.stopPropagation?b.stopPropagation():window.event&&(window.event.cancelBubsuble=!0)))}),s.find("li").click(function(b){var c=a(a(a(b.target).parents("li")).length>0?a(b.target).parents("li"):b.target);if(c.hasClass("disabled"))return!1;var d=a.trim(c.find(".ticket-title").text());t.find("span").text(d),s.addClass("hide");var e=c.data("coupon-amount");u.text(""),isNaN(e)||a.ajax({url:"/calculate-expected-interest/loan/"+g+"/amount/"+e,type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(a){u.text("+"+(a/100).toFixed(2)),j.prop("disabled",!1)})}),a("body").click(function(b){var c=b||window.event,d=c.srcElement||c.target;s.hasClass("hide")||0!=a(d).parents(".ticket-list").length||s.addClass("hide")})}n.length&&e.tips('<i class="fa fa-times-circle"></i>'+n.text(),".text-input-amount",{tips:[1,"#ff7200"],time:0})});