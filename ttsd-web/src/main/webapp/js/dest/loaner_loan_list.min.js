require(["jquery","mustache","text!/tpl/loaner-loan-table.mustache","text!/tpl/loaner-loan-repay-table.mustache","moment","underscore","daterangepicker","csrf"],function(a,b,c,d,e,f){function g(e){var g=m.val().split("~"),h=a.trim(g[0])||"",i=a.trim(g[1])||"",j=a(".status-filter .select-item.current").data("status"),k={startTime:h,endTime:i,status:j,index:e||1},n="";f.each(k,function(a,b){n+=b+"="+a+"&"}),a.ajax({url:"/loaner/loan-data?"+n,type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).success(function(e){var g=e.data;switch(l=g.index,j){case"REPAYING":g.isRepaying=!0;break;case"COMPLETE":g.isComplete=!0;break;case"CANCEL":g.isCancel=!0}var h=b.render(c,g);a(".loan-content").html(h),a(".loan-content .show-loan-repay").click(function(){a.ajax({url:a(this).data("url"),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).success(function(c){var e=c.data;if(e.isLoanCompleted="COMPLETE"==j,e.csrfToken=a("meta[name='_csrf']").attr("content"),e.status){f.each(e.records,function(a){switch(e.loanId=a.loanId,a.loanRepayStatus){case"REPAYING":a.status="待还";break;case"COMPLETE":a.status="完成";break;case"CANCEL":a.status="流标";break;case"CONFIRMING":a.status="确认中"}});var g=b.render(d,e);a(".layer-content").remove(),o.append(g).show(),a(".layer-container .close").click(function(){return o.hide(),!1}),a(".layer-container a.enabled-repay.normal").click(function(){return o.hide(),a("#normal-repay").submit(),!1}),a(".layer-container a.enabled-repay.advanced").click(function(){return e.hasConfirmingLoanRepay?!1:(o.hide(),a("#advanced-repay").submit(),!1)})}})})})}var h=e().format("YYYY-MM-DD"),i=e().subtract(1,"week").format("YYYY-MM-DD"),j=e().subtract(1,"month").format("YYYY-MM-DD"),k=e().subtract(6,"month").format("YYYY-MM-DD"),l=1,m=a("#date-picker");m.dateRangePicker({separator:" ~ "}).val(h+"~"+h),a(document).on("click",".pagination .nextPage",function(){l++,g(l)}),a(document).on("click",".pagination .prevPage",function(){l--,g(l)});var n=function(){var b=a(".date-filter .select-item.current").data("day");switch(b){case 1:m.val(h+"~"+h);break;case 7:m.val(i+"~"+h);break;case 30:m.val(j+"~"+h);break;case 180:m.val(k+"~"+h);break;default:m.val("")}},o=a(".layer-container");a(".layer-mask").click(function(){return o.hide(),!1}),a(".date-filter .select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),n(),g(1)}),a(".status-filter .select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),g(1)}),g(1),a(".apply-btn").click(function(){g(1)})});