require(["jquery","underscore","pagination","mustache","text!tpl/loan-invest-list.mustache","layerWrapper","fancybox"],function(a,b,c,d,e,f){function g(){noPasswordRemind||a.ajax({url:"/no-password-invest/mark-remind",type:"POST",dataType:"json"}).done(function(){noPasswordRemind=!0}),f.open({type:1,closeBtn:0,skin:"demo-class",title:"免密投资",shadeClose:!1,btn:autoInvestOn?["继续投资","开启免密投资"]:["继续投资","前往联动优势授权"],area:["500px","160px"],content:'<p class="pad-m-tb tc">推荐您开通免密投资功能，简化投资过程，理财快人一步！</p>',btn1:function(){cnzzPush.trackClick("标的详情页","马上投资弹框","继续投资B"),k(),f.closeAll()},btn2:function(){cnzzPush.trackClick("标的详情页","马上投资弹框",autoInvestOn?"开启免密投资":"前往联动优势授权"),autoInvestOn?a.ajax({url:"/no-password-invest/enabled",type:"POST",dataType:"json"}).done(function(){noPasswordInvest=!0,f.closeAll(),f.msg("开启成功！",function(){k()})}).fail(function(){f.closeAll(),f.msg("开启失败，请重试！")}):(showAuthorizeAgreementOptions(),$authorizeAgreement.submit())}})}a.fn.carousel=function(){return this.each(function(){var b=a(this),c=b.find(".left-button"),d=b.find(".right-button"),e=b.find(".scroll-content > .row"),f=e.find(".col"),g=f.length,h=0;c.on("click",function(){h++,h>g-4&&(h=g-4),e.stop().animate({marginLeft:-210*h})}),d.on("click",function(){h--,h<0&&(h=0),e.stop().animate({marginLeft:-210*h})})})},a.fn.tab=function(){return this.each(function(){var c=a(this),d=c.find(".title-block .item"),e=c.children(".content");d.each(function(c){a(this).on("click",b.partial(function(a,b){d.eq(b).addClass("active").siblings().removeClass("active"),e.hide().eq(b).show()},b,c))})})},a.fn.dropDown=function(b){return this.each(function(){var c=a(this),d=c.find(".dropdown-list"),e=d.find(".item"),f=c.find(".dropdown-main"),g=f.find(".text"),h=!1;f.on("click",function(a){return a.stopPropagation(),!f.hasClass("disabled")&&(h?d.hide():d.show(),void(h=!h))}),a(document).on("click",function(){d.hide(),h=!1}),e.on("click",function(c){c.stopPropagation();var e=a(this);return!e.hasClass("disabled")&&(e.addClass("active").find("input").prop("checked",!0).end().siblings().removeClass("active").find("input").prop("checked",!1),d.hide(),h=!1,g.text(e.data("text")),void(b&&b.onChange&&b.onChange(e.data("id"))))}),c.on("setOption",function(a,b){e.filter('[data-id="'+b+'"]').trigger("click")})})};var h=function(){var b=a("#invests-list-pagination");b.loadPagination({index:1},function(b){if(b.status){b.achievementClass=function(){return function(a,b){var c={FIRST_INVEST:"first-icon",MAX_AMOUNT:"max-icon",LAST_INVEST:"last-icon"};return"<i class='"+c[b(a)]+"'></i>"}};var c=d.render(e,b);a(".loan-list-con table").html(c)}})},i=function(){var c=a("#extra-rate");if(!c.length)return!1;var d={getSize:function(a,b){return a[b]()},getOffset:function(a){return a.offset()},removeElement:function(a){a.length&&a.remove()},getRelativeRate:function(a,c){var d=b.findLastIndex(__extraRate,function(a){if(c>=a.minInvestAmount&&(a.maxInvestAmount>c||0===a.maxInvestAmount))return!0});return d!==-1?a[d].rate:""},replace:function(a){return a.replace(/,/g,"")}},e=b.compose(b.template,function(){return a("#extra-rate-popup-tpl").html()})(),f=b.partial(d.getOffset,c),g=b.partial(d.getSize,c),h=(g("width"),g("height")),i=b.compose(b.partial(function(a,b){return{left:a.left,top:a.top+b-5}},b,h),f),j=b.partial(function(b,c){return a(b).css(c).appendTo("body")},b,i()),k=b.compose(j,e),l=b.partial(b.compose(d.removeElement,a),"#extra-rate-popup");c.find(".fa").on({mouseover:b.partial(k,{__extraRate:__extraRate}),mouseout:function(){l()}});var m=b.partial(d.getRelativeRate,__extraRate),n=function(){var b=a(".data-extra-rate");return function(a){b.html(a)}}(),o=function(a){return a?"+"+a:""};a("#invest-input").on("change",b.compose(n,o,m,parseInt,d.replace,function(){return a(this).val()})).trigger("change")},j=function(){var c=a("#invest-input").data("loan-id"),d=a(".experience-income"),e=a("#investSubmit"),f=function(b){var d=a.Deferred();return a.ajax({url:"/loan/"+c+"/amount/"+b+"/max-benefit-user-coupon",type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(c){isNaN(parseInt(c))?(a("#ttsd-dropdown").trigger("setOption","no"),d.reject()):(a("#ttsd-dropdown").trigger("setOption",c),d.resolve(c,b))}),d.promise()},g=function(b,f){var g=[];a.each(a('input[type="hidden"][name="userCouponIds"]'),function(b,c){g.push({name:"couponIds",value:a(c).data("coupon-id")})}),g.push({name:"couponIds",value:b}),a.ajax({url:"/calculate-expected-coupon-interest/loan/"+c+"/amount/"+f,data:a.param(g),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(a){d.text("+"+a),e.prop("disabled",!1)})},h=function(){d.text("")};a("#invest-input").on("input",b.debounce(function(b){var d=a(this).val();a.ajax({url:"/calculate-expected-interest/loan/"+c+"/amount/"+d,type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){a(".principal-income").text(b)}),f(d).then(g,h)},300))},k=function(){var b=a("#invest-submit-btn"),c="INVESTOR"===b.data("user-role"),d=b.data("no-password-remind"),e=b.data("no-password-invest");b.on("click",function(a){return a.preventDefault(),c?void(d||e?k():g()):void(location.href="/login?redirect="+encodeURIComponent(location.href))})};a(function(){a("[scroll-carousel]").carousel().find(".col").fancybox({titlePosition:"over",cyclic:!1,showCloseButton:!0,showNavArrows:!0,titleFormat:function(a,b,c,d){return"sdfsdf"}}),a("[data-tab]").tab(),a("#ttsd-dropdown").dropDown(),h(),i(),j(),k()})});