require(["underscore","jquery","jquery.validate","csrf"],function(a,b){var c=b(".register-step-one .register-user-form"),d=b(".image-captcha-dialog .image-captcha-form"),e=b(".register-user-form .fetch-captcha"),f=b(".image-captcha-dialog .image-captcha"),g=b(".image-captcha-dialog .image-captcha-text");e.on("click",function(){h(!0)}),b(".image-captcha-dialog .close").on("click",function(){h(!1)});var h=function(a){var c=b(".image-captcha-dialog-mask"),d=b(".image-captcha-dialog");if(a){var e=b(window).height();b(".image-captcha-form label").remove(),c.css({height:e,display:"block"}),g.val(""),d.show(),i()}else d.hide(),c.hide()},i=function(){f.attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())};f.click(function(){i()}),b.validator.addMethod("regex",function(a,b,c){var d=new RegExp(c);return this.optional(b)||d.test(a)},"请检查您的输入");var j=function(a,c,d){var e=!1,f=d.validator,g=d.element,h=f.previousValue(g),i=d.errorMessage;b.ajax({url:a,type:"GET",dataType:"json",error:function(a){h.valid=e,f.stopRequest(g,e)},success:function(a){if(e=c(a)){var d=f.formSubmitted;f.prepareElement(g),f.formSubmitted=d,f.successList.push(g),delete f.invalid[g.name],f.showErrors()}else{var j={};j[g.name]=h.message=b.isFunction(i)?i(value):i,f.invalid[g.name]=!0,f.showErrors(j)}h.valid=e,f.stopRequest(g,e)}})},k=function(a,c,d){var e=this.previousValue(c),f=this;if(e.old===a)return e.valid;e.old=a,this.startRequest(c);var g=f.defaultMessage(c,"isExist"),h=function(a){return a.success&&!a.data.status},i=b.validator.format(d);return j(i(a),h,{validator:f,element:c,errorMessage:g}),"pending"},l=function(a,c,d){var e=this.previousValue(c),f=this;if(""===b(".register .referrer").val())return f.showErrors(),"pending";if(e.old===a)return e.valid;e.old=a,this.startRequest(c);var g=f.defaultMessage(c,"isNotExist"),h=function(a){return a.success&&a.data.status},i=b.validator.format(d);return j(i(a),h,{validator:f,element:c,errorMessage:g}),"pending"},m=function(a,c,d){var e=this.previousValue(c),f=this;if(e.old===a)return e.valid;e.old=a,this.startRequest(c);var g=f.defaultMessage(c,"imageCaptchaVerify"),h=function(a){return a.success&&a.data.status},i=b.validator.format(d);return j(i(a),h,{validator:f,element:c,errorMessage:g}),"pending"},n=function(a,c,d){var e=this.previousValue(c),f=this,g=f.check(".register .mobile");if(!g)return!1;if(e.old===a)return e.valid;e.old=a,this.startRequest(c);var h=f.defaultMessage(c,"captchaVerify"),i=function(a){return a.success&&a.data.status},k=b.validator.format(d);return j(k(a),i,{validator:f,element:c,errorMessage:h}),"pending"};b.validator.addMethod("isExist",function(a,b,c){return k.call(this,a,b,c)},b.validator.format("该记录已存在")),b.validator.addMethod("isNotExist",function(a,b,c){return l.call(this,a,b,c)},b.validator.format("该记录已存在")),b.validator.addMethod("captchaVerify",function(a,b,c){return n.call(this,a,b,c)},b.validator.format("手机验证码不正确")),b.validator.addMethod("imageCaptchaVerify",function(a,b,c){return m.call(this,a,b,c)},b.validator.format("图形验证码不正确"));var o=function(a){b.ajax({url:d.attr("action"),type:"post",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=UTF-8",success:function(a){if(a.data.status){h(!1);var b=60,c=setInterval(function(){e.html(b+"秒后重新发送").css({background:"#666","pointer-events":"none"}),0==b&&(clearInterval(c),e.html("重新发送").css({background:"#f68e3a","pointer-events":"auto"})),b--},1e3)}else{var f=d.validate();f.resetForm(),f.checkForm()}}})};d.validate({success:"valid",focusCleanup:!0,focusInvalid:!1,onkeyup:!1,onfocusout:function(a){this.element(a)},submitHandler:function(c){var d=b(".mobile").val(),e=["imageCaptcha"],f=c.elements,g={mobile:d};return a.each(f,function(a){-1!==e.indexOf(a.name)&&(g[a.name]=a.value)}),o(g),!1},showErrors:function(a,b){this.__proto__.defaultShowErrors.call(this),a.imageCaptcha&&i()},rules:{imageCaptcha:{required:!0,regex:"^[a-zA-Z0-9]{5}$",imageCaptchaVerify:"/register/user/image-captcha/{0}/verify"}},messages:{imageCaptcha:{required:"请输入图形验证码",regex:"图形验证码不正确",imageCaptchaVerify:"图形验证码不正确"}}}),c.validate({focusCleanup:!0,focusInvalid:!1,onkeyup:!1,onfocusout:function(a){this.element(a)},showErrors:function(a,c){this.__proto__.defaultShowErrors.call(this),a.mobile&&b(".fetch-captcha").addClass("grey").attr("disabled","disabled")},success:function(a,c){a.addClass("valid"),"mobile"===c.name&&b(".fetch-captcha").removeClass("grey").removeAttr("disabled")},rules:{loginName:{required:!0,rangelength:[5,25],regex:"(?!^\\d+$)^([a-zA-Z0-9]+)$",isExist:"/register/user/login-name/{0}/is-exist"},mobile:{required:!0,digits:!0,rangelength:[11,11],isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,rangelength:[6,20],regex:"^(?=.*[0-9])(?=.*[a-zA-Z])([a-zA-Z0-9]+)$"},captcha:{required:!0,digits:!0,rangelength:[6,6],captchaVerify:{param:function(){var a=b(".register .mobile").val();return"/register/user/mobile/"+a+"/captcha/{0}/verify"}}},referrer:{isNotExist:"/register/user/login-name/{0}/is-exist"},agreement:{required:!0}},messages:{loginName:{required:"请输入用户名",regex:"字母和数字组合",rangelength:"长度5至25位",isExist:"用户名已存在"},mobile:{required:"请输入手机号",digits:"手机号格式不正确",rangelength:"手机号格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"只能字母和数字组合",rangelength:"长度6至20位"},captcha:{required:"请输入验证码",digits:"验证码格式不正确",rangelength:"验证码格式不正确",captchaVerify:"验证码不正确"},referrer:{isNotExist:"推荐人不存在"},agreement:{required:"请同意服务协议"}}})});