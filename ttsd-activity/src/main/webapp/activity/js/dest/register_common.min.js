define(["jquery","underscore","layerWrapper","commonFun","placeholder","jquery.validate","jquery.validate.extension","jquery.form","jquery.ajax.extension"],function(a,b,c){var d=a("#registerCommonFrame"),e=a(".register-user-form",d),f=a("#mobile",d),g=a(".fetch-captcha",d),h=a(".img-change",d),i=a("#appCaptcha",d),j=commonFun.browserRedirect(),k=!1,l=!1,m=!1;a('input[type="text"],input[type="password"]',e).placeholder(),e.validate({focusInvalid:!1,errorPlacement:function(b,c){b.appendTo(a("#"+c.attr("id")+"Err"))},rules:{mobile:{required:!0,digits:!0,isPhone:!0,minlength:11,maxlength:11,isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,regex:/^(?=.*[^\d])(.{6,20})$/},appCaptcha:{required:!0},captcha:{required:!0,digits:!0,maxlength:6,minlength:6,checkCaptcha:!0},agreement:{required:!0}},messages:{mobile:{required:"请输入手机号",digits:"必须是数字",minlength:"手机格式不正确",isPhone:"请输入正确的手机号码",maxlength:"手机格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"6位至20位，不能全是数字"},appCaptcha:{required:"请输入验证码"},captcha:{required:"请输入手机验证码",digits:"验证码格式不正确",maxlength:"验证码格式不正确",minlength:"验证码格式不正确",checkCaptcha:"验证码不正确"},agreement:{required:"请同意服务协议"}},submitHandler:function(a){a.submit()}});var n=function(){a(".image-captcha img").each(function(b,c){a(this).attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())})};n(),h.on("touchstart",function(a){a.preventDefault(),n()}),a(".show-agreement").on("touchstart",function(b){b.preventDefault();var d=["950px","600px"];"mobile"==j&&(d=["100%","100%"]),c.open({type:1,title:"拓天速贷服务协议",area:d,shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:a("#agreementBox")})}),a("#agreementBox").find(".close-tip").on("touchstart",function(){c.closeAll()}),i.on("keyup",function(b){/^\d{5}$/.test(b.target.value)&&(a(b.target).addClass("valid").removeClass("error"),m=!0,k=f.hasClass("valid"),l=a(".password",d).hasClass("valid"),k&&l&&m?(console.log("ok"),g.prop("disabled",!1),a("#appCaptchaErr").html("")):(g.prop("disabled",!0),console.log("error")))}),g.on("touchstart",function(b){var d=a(this);if(b.preventDefault(),!d.prop("disabled")){g.prop("disabled",!0);var e=i.val(),h=f.val();a.ajax({url:"/register/user/send-register-captcha",type:"POST",dataType:"json",data:{imageCaptcha:e,mobile:h}}).done(function(b){var c,d=b.data,e=60;return d.status&&!d.isRestricted?void(c=setInterval(function(){g.prop("disabled",!0).text(e+"秒后重发"),e--,0==e&&(clearInterval(c),g.prop("disabled",!1).text("重新发送"))},1e3)):(!d.status&&d.isRestricted&&a("#appCaptchaErr").html("短信发送频繁,请稍后再试"),void(d.status||d.isRestricted||(a("#appCaptchaErr").html("图形验证码错误"),n())))}).fail(function(){c.msg("请求失败，请重试！"),g.prop("disabled",!1),n()})}}),jQuery.validator.addMethod("isPhone",function(a,b){var c=/0?(13|14|15|18)[0-9]{9}/;return this.optional(b)||c.test(a)},"请正确填写您的手机号码"),jQuery.validator.addMethod("checkCaptcha",function(b,c){var d=f.val(),e=a.Deferred();return/^\d{6}$/.test(b)&&d?a.ajax({url:"/register/user/mobile/"+d+"/captcha/"+b+"/verify",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(e.resolve(),m=!0):(e.reject(),m=!1)}}):(e.reject(),m=!1),"resolved"==e.state()},"验证码不正确")});